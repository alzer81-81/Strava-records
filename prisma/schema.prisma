generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum PlanType {
  FREE
  PRO
}

enum PlanStatus {
  ACTIVE
  CANCELED
  EXPIRED
}

enum PeriodType {
  WEEK
  MONTH
  LAST_2M
  LAST_6M
  YEAR
  ALL_TIME
}

enum SportType {
  RUN
  RIDE
  OTHER
}

enum EffortKind {
  best_effort
}

enum GroupRole {
  OWNER
  MEMBER
}

enum SyncStatus {
  PENDING
  RUNNING
  DONE
  ERROR
}

model User {
  id               String       @id @default(uuid())
  stravaAthleteId  String       @unique
  accessToken      String
  refreshToken     String
  expiresAt        Int
  plan             PlanType     @default(FREE)
  planStatus       PlanStatus   @default(ACTIVE)
  planExpiresAt    DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  activities       Activity[]
  effortCaches     EffortCache[]
  periodSummaries  PeriodSummary[]
  records          Record[]
  groupsOwned      Group[]      @relation("GroupOwner")
  groupMembers     GroupMember[]
}

model Activity {
  id                String   @id
  userId            String
  startDate         DateTime
  timezone          String?
  sportType         SportType
  name              String?
  distance          Float
  movingTime        Int
  elapsedTime       Int
  elevationGain     Float
  averageSpeed      Float
  maxSpeed          Float
  averageHeartrate  Float?
  startLat          Float?
  startLng          Float?
  summaryPolyline   String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startDate])
}

model EffortCache {
  id          String     @id @default(uuid())
  userId      String
  activityId  String
  kind        EffortKind
  payload     Json
  updatedAt   DateTime   @updatedAt

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, activityId, kind])
}

model PeriodSummary {
  id            String     @id @default(uuid())
  userId        String
  periodType    PeriodType
  periodKey     String
  sportType     SportType
  totals        Json
  avgSpeed      Float
  bestActivityIds Json?
  updatedAt     DateTime   @updatedAt

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodType, periodKey, sportType])
}

model Record {
  id              String     @id @default(uuid())
  userId          String
  windowType      PeriodType
  windowKey       String
  sportType       SportType
  distanceTarget  Int
  bestTimeSeconds Int
  activityId      String
  achievedAt      DateTime
  updatedAt       DateTime   @updatedAt

  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, windowType, windowKey, sportType, distanceTarget])
}

model Group {
  id         String        @id @default(uuid())
  name       String
  ownerId    String
  inviteCode String        @unique
  createdAt  DateTime      @default(now())

  owner      User          @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members    GroupMember[]
}

model GroupMember {
  id        String     @id @default(uuid())
  groupId   String
  userId    String
  role      GroupRole
  joinedAt  DateTime   @default(now())

  group     Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
}

model SyncJob {
  id               String     @id @default(uuid())
  userId           String
  status           SyncStatus
  phase            String
  totalSteps       Int?
  processedSteps   Int        @default(0)
  totalActivities  Int?
  detailFetched    Int?
  errorMessage     String?
  startedAt        DateTime?
  finishedAt       DateTime?
  updatedAt        DateTime   @updatedAt
  @@index([userId, status])
}
